<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ¤å®šã‚«ãƒ¡ãƒ©</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #999; margin: 0; padding: 20px; }
        video, img { width: 100%; max-width: 500px; border-radius: 10px; display: block; margin: 10px auto; }
        #btn-shutter { padding: 15px 30px; font-size: 1.2rem; cursor: pointer; border-radius: 30px; border: none; background: #333; color: white; }
        #btn-shutter.active { background: #d9534f; }
        #loading { display: none; color: #002255; font-weight: bold; }
    </style>
</head>
<body>
    <h2>AIãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ¤å®šã‚«ãƒ¡ãƒ©</h2>
    <video id="video" autoplay playsinline></video>
    <button id="btn-shutter">ğŸ“¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ¤å®šé–‹å§‹</button>
    <p id="loading">AIè§£æä¸­...</p>
    <img id="photo-result">
    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const btnShutter = document.getElementById('btn-shutter');
        const photoResult = document.getElementById('photo-result');
        const loadingMsg = document.getElementById('loading');

        // â˜…ã‚ãªãŸã®Renderã®URLã«æ›¸ãæ›ãˆã¦ãã ã•ã„
        const API_URL = "https://my-yolo-api-h2h5.onrender.com/detect";

        let isDetecting = false;

        // ã‚«ãƒ¡ãƒ©èµ·å‹•
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(stream => { video.srcObject = stream; });

        btnShutter.addEventListener('click', () => {
            if (!isDetecting) {
                isDetecting = true;
                btnShutter.textContent = "â¹ åœæ­¢ã™ã‚‹";
                btnShutter.classList.add('active');
                startDetectionLoop();
            } else {
                isDetecting = false;
                btnShutter.textContent = "ğŸ“¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ¤å®šé–‹å§‹";
                btnShutter.classList.remove('active');
                loadingMsg.style.display = 'none';
            }
        });

        async function startDetectionLoop() {
            while (isDetecting) {
                const context = canvas.getContext('2d');
                // é€šä¿¡è»½é‡åŒ–ã®ãŸã‚ã‚µã‚¤ã‚ºã‚’ç¸®å°
                canvas.width = video.videoWidth * 0.5;
                canvas.height = video.videoHeight * 0.5;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                loadingMsg.style.display = 'block';

                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.6));
                const formData = new FormData();
                formData.append('file', blob, 'image.jpg');

                try {
                    const response = await fetch(API_URL, { method: 'POST', body: formData });
                    if (response.ok && isDetecting) {
                        const resultBlob = await response.blob();
                        photoResult.src = URL.createObjectURL(resultBlob);
                    }
                } catch (err) {
                    console.error("é€šä¿¡ã‚¨ãƒ©ãƒ¼:", err);
                }

                // ã‚µãƒ¼ãƒãƒ¼ã®è² è·è»½æ¸›ã®ãŸã‚1.5ç§’å¾…æ©Ÿ
                await new Promise(resolve => setTimeout(resolve, 1500));
            }
        }
    </script>
</body>
</html>
